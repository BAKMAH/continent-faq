.. _diag:

***********
Диагностика
***********

Проверка бекапа на VM
=======================

Перед тем как обновить ПО, не зависимо от того мажорный это релиз или нет, возникает вполне резонное желание опробовать как конфиг с одной версии ПО применится в другой. А так же, очень полезно проверить есть ли какие-то проблемы с тем, чтобы развернуть бекапы на **текущей** версии софта. Увы, ничто не идеально и проверять нужно всё.

Для версии 3.7.5-3.9.* рекомендуется использовать следующие гипервизоры: VMWare, VirtualBox(vbox).
У обоих гипервизоров есть свои особенности и недостатаки.

Создание VM для ЦУС
^^^^^^^^^^^^^^^^^^^

Для обоих гипервизоров выбор профиля ОС одинаков для версии 3.7.5. Это 32-х разрядная версия FreeBSD. Начиная с версии 3.9 и выше это 64-битная система.
Необходимые ресурсы для VM:

* ЦПУ 1 и более количество ядер
* ОЗУ 1024 Мб и более
* Объем HDD 2 Гб и более
* USB контроллер не ниже v2.0

.. note::
	Количество сетевых интерфейсов зависит от того сколько их на вашем реальном ЦУС, и сколько можно добавить в определенном гипервизоре. В VMWare максимальное количество сетевых интерфесов <=8, в VBox зависит от платформы где работает гипервизор (Linux - phpvitualbox >14; Windows <=6). При использовании гипервизора который не поддерживает большее количество интерфейсов, чем на вашем ЦУС, можно получить определнные ограничения для проверки конфига, о них далее.

Установка ПО на VM
^^^^^^^^^^^^^^^^^^
В зависимости от версии существуют разные образы для установки на VM. Более старые делятся на "vm_release" и "vm_debug", мы рекомендуем сразу устанавливать **debug** версию. Установка проходит в обычном режиме. В качестве ID (КШ №) необходимо указать ID вашего ЦУС.

Подготовка ЦУС
^^^^^^^^^^^^^^
Для того чтобы можно было залить вашу конфигурацию на **виртулаьный** ЦУС необходимо отредактировать интерфейсы в соотвествии с тем как они есть на **реальном** ЦУС.

Если гипервизор поддерживает необходимое количество интерфейсов, то это хорошо и вам необходимо минимум теледвижений. Для начала нужно включить "мягкий режим" на ЦУС, или настроить соотвествующие правила фильтрации для доступа на ЦУС по ssh (tcp/22).
Реквизиты для доступа на ЦУС по умолчанию в **debug** версии:

* Логин: root
* Пароль: chay6spu3reswefE

После успешного подключения к ЦУС по протоколу SSH нужно перейти в дирикторию
:guilabel:`cd /etc/rc.startup/`.
В ней создать пустой файл: 
:guilabel:`cat /dev/null >/etc/rc.startup/001if`. 
И записать в него скрипт который будет переименовывать интерфейсы **до** старта демона/сервиса ЦУС.

Пример скрипта для переименовывания интерфейсов под IPC-3000F::

	cat << end >> /etc/rc.startup/001if
	#!/bin/sh
	ifconfig em0 name ix0
	ifconfig em1 name ix1
	ifconfig em2 name igb0
	ifconfig em3 name igb1
	ifconfig em4 name igb2
	ifconfig em5 name igb3
	ifconfig em6 name igb4
	ifconfig em7 name igb5
	ifconfig em8 name igb6
	ifconfig em9 name igb7
	ifconfig em10 name em0
	ifconfig em11 name em1
	ifconfig em12 name ix2
	ifconfig em13 name ix3
	end

Далее нужно сделать скрипт исполняемым :guilabel:`chmod +x /etc/rc.startup/001if`, после чего перезагрузить КШ коммандой :guilabel:`reboot`.
Если всё прошло гладко, то при выводе списка интерфейсов, через меню Alt+F2, у вас будут названия те которые вы задавали в скрипте.

.. note::
	Если выбранный вами гипервизор не поддерживает нужное количество интерфейсов, их можно создать используя тот же скрипт переименовывания интерфейсов.
	Пример::
	
	ifconfig tun1 create; ifconfig tun1 name em1
	ifconfig tun2 create; ifconfig tun2 name em2
	...
	
.. attention::
	Интерфейсы tun являются не настоящими с точки зрения виртуальной машины. Если на подобном tun интерфейсе будет назначен какой-либо IP адрес, он не будет доступен в виртуальной сетевой инфраструктуре. В этом случае в скрипте учитывать порядок создания и переименовая интерфейсов. Если невозможно закрыть все условные "пробелы" tun интерфейсами, нужно выбрать более подходящий гипервизор для этих целей.

После перезагрузки виртуальной машины необходимо переинизиализировать ЦУС. По этому можно сразу зайти в меню администратора, вход в которое доступен в течении 5 секунд.
В меню администратора нужно зайти в:
:guilabel:`3: Управление` > :guilabel:`4: Переинизиализировать ЦУС`.

Загрузка конфига в ЦУС
^^^^^^^^^^^^^^^^^^^^^^
После переинициализации ЦУС нужно подключиться к нему используя ключ который был создан при **инициализации**. Далее загрузить кофинг и после того как ЦУС перезагрузится и применит новую конфигурацию, нужно использовать ключ который используюется для подключения к **реальному** ЦУС или можно создать новый ключ в меню администратора:
:guilabel:`4: Настройки безопасности` > :guilabel:`1: Зарегистрировать нового администратора`.
