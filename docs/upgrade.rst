.. _upgrade:

Обновление ПО  
=============

В жизни каждого администратора АПКШ Континент наступает тот момент, когда необходимо произвести обновление ПО.

-----

.. note::

   ЦУС (он же КШ с ЦУСом) обновляется только локально!

.. contents::

Обновления ПО можно разделить на:

   * обновление мажорной версии (обновление с 3.6 на 3.7)
   * обновление минорной версии (обновление с 3.7.5 на 3.7.7)

.. attention::

   Лицензия на обновление ПО требуется только в случае обновления на мажорную версию!
   Обновление с 3.6 на 3.7, с 3.7 на 3.9 и так далее!

Обновление мажорной версии
--------------------------

При обновление мажорной версии ПО, к примеру обновление сети с версии 3.6.90.4 на версию 3.7.7.761 следует выполнить следующие действия:

   * убедиться в наличии лицензии на обновление (приобретается вместе с правом на обновление, без нее не удастся обновить устройства комплекса после обновления ЦУСа)
   * внимательно ознакомится с документом Release Notes (в нем описаны все нюансы обновления и измененный функционал)
   * сохранить резервную копию БД ЦУС (сделать копию дважды и сохранить ее в нескольких местах)
   * выполнить рекомендации из Release Notes на текущей версии ПО
   * сохранить резервную копию БД ЦУС (сделать копию дважды и сохранить ее в нескольких местах)
   * произвести смену ключей всех устройств комплекса (в случае, если ключи истекли)
   * сохранить резервную копию БД ЦУС (сделать копию дважды и сохранить ее в нескольких местах)
   * проверить восстановление из резервной копии БД ЦУС, сохраненной на предыдущем шаге (при возможности)
   * сохранить ключ администратора (не удалять его и не переписывать при инициализации новой версии ПО)
   * установить ПО новой версии на ЦУС, установить новую версию ПУ ЦУС
   * произвести инициализацию ЦУС (можно использовать временные параметры, после восстановления БД ЦУС на новой версии все настройки восстановятся в соответствии со старой конфигурацией, такие как адреса интерфейсов, маршрутизация, ключи администратора)
   * подключится ПУ ЦУС к ЦУС и восстановить БД ЦУС из последней сохраненной резервной копии (ЦУС автоматически перезагрузится после восстановления БД)
   * подключится ПУ ЦУС к ЦУС с ключом администратора версии 3.6
   * добавить лицензии на обновление ПО
   * загрузить файл дистанционного обновления (ПУ ЦУС - Свойства - Обновление)
   * обновить устройства комплекса:
      - дистанционно (в свойствах устройства перейти на вкладку "Версии ПО" и выполнить обновление указав платформу устройства)
      - локально (сохранить конфигурацию и ключи устройства в ПУ ЦУС на USB Flash, установить на устройство новую версию ПО локально, залить конфигурацию и ключи)
   * после обновления всех устройств комплекса сохранить резервную копию БД ЦУС новой версии (сделать копию дважды и сохранить ее в нескольких местах)

.. attention::
   
   При обновлении с версий 3.5 и 3.6 на версию 3.7 возможна ситуация, когда дистанционное обновление ПО не устанавливается на устройства.
   В большинстве случаев это связанно с тем, что корневой раздел устройства заполнен.
   В случае ошибки демонов создаются отладочные дампы процессов или ядра, начиная с версии 3.7.5.493 их создание отключено.
   В данном случае следует поставить обновление **preupdate.tar** которое выполнит очистку свободного места на диске и позволит загрузить пакет обновления.
   Другим выходом из ситуации является локальное обновление ПО, рекомендуется по возможности использовать его при мажорных обновлениях.

Обновление минорной версии
--------------------------

Обновление минорной версии обычно проходит без проблем и не требует повышенного внимания к нюансам из Release Notes.
При обновление минорной версии ПО, к примеру обновление сети с версии 3.7.5.493 на версию 3.7.7.761 следует выполнить следующие действия:

   * внимательно ознакомится с документом Release Notes (в нем описаны все нюансы обновления и измененный функционал)
   * сохранить резервную копию БД ЦУС (сделать копию дважды и сохранить ее в нескольких местах)
   * выполнить рекомендации из Release Notes на текущей версии ПО
   * сохранить резервную копию БД ЦУС (сделать копию дважды и сохранить ее в нескольких местах)
   * произвести смену ключей всех устройств комплекса (в случае, если ключи истекли)
   * сохранить резервную копию БД ЦУС (сделать копию дважды и сохранить ее в нескольких местах)
   * проверить восстановление из резервной копии БД ЦУС, сохраненной на предыдущем шаге (при возможности)
   * сохранить ключ администратора (не удалять его и не переписывать при инициализации новой версии ПО)
   * установить ПО новой версии на ЦУС, установить новую версию ПУ ЦУС
   * произвести инициализацию ЦУС (можно использовать временные параметры, после восстановления БД ЦУС на новой версии все настройки восстановятся в соответствии со старой конфигурацией, такие как адреса интерфейсов, маршрутизация, ключи администратора)
   * подключится ПУ ЦУС к ЦУС и восстановить БД ЦУС из последней сохраненной резервной копии (ЦУС автоматически перезагрузится после восстановления БД)
   * подключится ПУ ЦУС к ЦУС с ключом администратора предыдущей версии
   * загрузить файл дистанционного обновления (ПУ ЦУС - Свойства - Обновление)
   * обновить устройства комплекса:
      - дистанционно (в свойствах устройства перейти на вкладку "Версии ПО" и выполнить обновление указав платформу устройства)
      - локально (сохранить конфигурацию и ключи устройства в ПУ ЦУС на USB Flash, установить на устройство новую версию ПО локально, залить конфигурацию и ключи)
   * после обновления всех устройств комплекса сохранить резервную копию БД ЦУС новой версии (сделать копию дважды и сохранить ее в нескольких местах)

-----

Обновление Сервера Доступа
--------------------------

Обновление СД не привязано к конфигурации интерфейсов, платформе или же к идентификатору клиента.
При дистанционном обновлении нет необходимости выполнять дополнительные действия по обновлению СД.

.. attention::
   
   Всегда, запомни, всегда делай резервные копии не только базы СД, но и закрытых ключей!
   
   Без закрытых ключей СД базу не восстановить и она превратится в тыкву!

Для локального обновления СД необходимо:

* создать резервную копию базы СД через ПУ СД (сделать копию дважды и сохранить ее в нескольких местах)
* сохранить ключ администратора СД 
* создать резервную копию закрытого ключа СД через Код Безопасности CSP (так же сохранить его в нескольких местах)
* после того, как устройство обновлено, в локальном меню инициализировать СД
* подключиться ПУ СД  к СД с новым ключом администратора, созданным на предыдущем шаге
* восстановить конфигурацию СД из резервной копии

.. note::

   Для создания резервной копии закрытого ключа корневого сертификата СД необходимо средствами КБ CSP осуществить перемещение закрытого ключа на носитель (USB Flash), затем средствами ОС скопировать с носителя директорию topsecretkeys.
   При копировании ключей через КБ CSP (используя его встроенный функционал) копию ключа будет невозможно использовать в СД. Есть такой нюанс.



